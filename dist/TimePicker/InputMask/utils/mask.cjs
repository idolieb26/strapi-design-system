"use strict";const P=require("./helpers.cjs"),u=require("./parse-mask.cjs");class m{constructor(t){this.maskOptions=u(t)}isCharacterAllowedAtPosition=(t,i)=>{const{maskPlaceholder:e}=this.maskOptions;return this.isCharacterFillingPosition(t,i)?!0:e?e[i]===t:!1};isCharacterFillingPosition=(t,i)=>{const{mask:e}=this.maskOptions;if(!t||i>=e.length)return!1;if(!this.isPositionEditable(i))return e[i]===t;const r=e[i];return new RegExp(r).test(t)};isPositionEditable=t=>{const{mask:i,permanents:e}=this.maskOptions;return t<i.length&&e.indexOf(t)===-1};isValueEmpty=t=>t.split("").every((i,e)=>!this.isPositionEditable(e)||!this.isCharacterFillingPosition(i,e));isValueFilled=t=>this.getFilledLength(t)===this.maskOptions.lastEditablePosition+1;getDefaultSelectionForValue=t=>{const i=this.getFilledLength(t),e=this.getRightEditablePosition(i);return{start:e,end:e}};getFilledLength=t=>{const i=t.split("");return P.findLastIndex(i,(r,l)=>this.isPositionEditable(l)&&this.isCharacterFillingPosition(r,l))+1};getStringFillingLengthAtPosition=(t,i)=>t.split("").reduce((l,a)=>this.insertCharacterAtPosition(l,a,l.length),P.repeat(" ",i)).length-i;getLeftEditablePosition=t=>{for(let i=t;i>=0;i--)if(this.isPositionEditable(i))return i;return null};getRightEditablePosition=t=>{const{mask:i}=this.maskOptions;for(let e=t;e<i.length;e++)if(this.isPositionEditable(e))return e;return null};formatValue=t=>{const{maskPlaceholder:i,mask:e}=this.maskOptions;if(!i){for(t=this.insertStringAtPosition("",t,0);t.length<e.length&&!this.isPositionEditable(t.length);)t+=e[t.length];return t}return this.insertStringAtPosition(i,t,0)};clearRange=(t,i,e)=>{if(!e)return t;const r=i+e,{maskPlaceholder:l,mask:a}=this.maskOptions,h=t.split("").map((c,n)=>{const s=this.isPositionEditable(n);return!l&&n>=r&&!s?"":n<i||n>=r?c:s?l?l[n]:"":a[n]}).join("");return this.formatValue(h)};insertCharacterAtPosition=(t,i,e)=>{const{mask:r,maskPlaceholder:l}=this.maskOptions;if(e>=r.length)return t;const a=this.isCharacterAllowedAtPosition(i,e),h=this.isPositionEditable(e),c=this.getRightEditablePosition(e),n=l&&c?i===l[c]:null,s=t.slice(0,e);if(a||!h){const g=a?i:r[e];t=s+g}return!a&&!h&&!n&&(t=this.insertCharacterAtPosition(t,i,e+1)),t};insertStringAtPosition=(t,i,e)=>{const{mask:r,maskPlaceholder:l}=this.maskOptions;if(!i||e>=r.length)return t;const a=i.split(""),h=this.isValueFilled(t)||!!l,c=t.slice(e);return t=a.reduce((n,s)=>this.insertCharacterAtPosition(n,s,n.length),t.slice(0,e)),h?t+=c.slice(t.length-e):this.isValueFilled(t)?t+=r.slice(t.length).join(""):t=c.split("").filter((s,g)=>this.isPositionEditable(e+g)).reduce((s,g)=>{const d=this.getRightEditablePosition(s.length);return d===null?s:(this.isPositionEditable(s.length)||(s+=r.slice(s.length,d).join("")),this.insertCharacterAtPosition(s,g,s.length))},t),t};processChange=(t,i)=>{const{mask:e,prefix:r,lastEditablePosition:l}=this.maskOptions,{value:a,selection:h}=t,c=i.value,n=i.selection;let s=a,g="",d=0,f=0,o=Math.min(n.start,h.start);return h.end>n.start?(g=s.slice(n.start,h.end),d=this.getStringFillingLengthAtPosition(g,o),d?f=n.length:f=0):s.length<c.length&&(f=c.length-s.length),s=c,f&&(f===1&&!n.length&&(o=n.start===h.start?this.getRightEditablePosition(h.start):this.getLeftEditablePosition(h.start)),s=this.clearRange(s,o,f)),s=this.insertStringAtPosition(s,g,o),o+=d,o>=e.length?o=e.length:o<r.length&&!d?o=r.length:o>=r.length&&o<l&&d&&(o=this.getRightEditablePosition(o)),s=this.formatValue(s),{value:s,enteredString:g,selection:{start:o,end:o}}}}module.exports=m;
